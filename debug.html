<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•é¡µé¢ - æ—©è¯»ç¥å™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .pass { color: green; }
        .fail { color: red; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 5px;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #log {
            background: #333;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ› æ—©è¯»ç¥å™¨è°ƒè¯•é¡µé¢</h1>

    <div class="warning">
        <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong><br>
        ç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶ï¼ˆfile://ï¼‰æ— æ³•ä½¿ç”¨éº¦å…‹é£åŠŸèƒ½ï¼<br>
        æ‚¨å¿…é¡»é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®ï¼Œå¦‚ http://localhost:8080
    </div>

    <div class="test-item">
        <h3>1. æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ</h3>
        <div id="browser-support"></div>
    </div>

    <div class="test-item">
        <h3>2. æ£€æŸ¥å½“å‰è®¿é—®æ–¹å¼</h3>
        <div id="protocol-check"></div>
    </div>

    <div class="test-item">
        <h3>3. éº¦å…‹é£æƒé™æµ‹è¯•</h3>
        <button id="test-mic">æµ‹è¯•éº¦å…‹é£</button>
        <div id="mic-status"></div>
    </div>

    <div class="test-item">
        <h3>4. JavaScriptæ§åˆ¶å°æ—¥å¿—</h3>
        <div id="log">ç­‰å¾…æ—¥å¿—...</div>
    </div>

    <div class="test-item">
        <h3>5. å¿«é€Ÿè§£å†³æ–¹æ¡ˆ</h3>
        <p><strong>å¦‚æœçœ‹åˆ°é”™è¯¯ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</strong></p>
        <ol>
            <li>æ‰“å¼€å‘½ä»¤æç¤ºç¬¦ï¼ˆCMDï¼‰</li>
            <li>è¾“å…¥ï¼š<code>cd /d D:\CodeProjects\morning-reading-zoo</code></li>
            <li>è¾“å…¥ï¼š<code>python -m http.server 8080</code></li>
            <li>æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š<a href="http://localhost:8080" target="_blank">http://localhost:8080</a></li>
        </ol>
        <p>æˆ–ç›´æ¥åŒå‡»è¿è¡Œï¼š<strong>å¯åŠ¨æœåŠ¡å™¨.bat</strong></p>
    </div>

    <script>
        // é‡å†™console.logä»¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        const logElement = document.getElementById('log');
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            logElement.textContent += args.join(' ') + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        };

        // 1. æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        function checkBrowserSupport() {
            const support = document.getElementById('browser-support');
            const checks = [
                { name: 'getUserMedia', supported: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) },
                { name: 'AudioContext', supported: !!(window.AudioContext || window.webkitAudioContext) },
                { name: 'Canvas', supported: !!document.createElement('canvas').getContext },
                { name: 'ES6 Modules', supported: !!(document.createElement('script').noModule !== undefined) },
                { name: 'localStorage', supported: !!window.localStorage }
            ];

            let html = '';
            checks.forEach(check => {
                html += `<div class="${check.supported ? 'pass' : 'fail'}">
                    ${check.supported ? 'âœ“' : 'âœ—'} ${check.name}: ${check.supported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}
                </div>`;
            });

            // æ£€æŸ¥åè®®
            const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';
            checks.push({ name: 'å®‰å…¨ä¸Šä¸‹æ–‡', supported: isHTTPS });

            html += `<div class="${isHTTPS ? 'pass' : 'fail'}">
                ${isHTTPS ? 'âœ“' : 'âœ—'} è®¿é—®æ–¹å¼: ${location.protocol} ${isHTTPS ? '(æ­£ç¡®)' : '(é”™è¯¯ - éœ€è¦HTTPSæˆ–localhost)'}
            </div>`;

            support.innerHTML = html;
        }

        // 2. æ£€æŸ¥åè®®
        function checkProtocol() {
            const check = document.getElementById('protocol-check');
            const protocol = location.protocol;
            const hostname = location.hostname;

            if (protocol === 'file:') {
                check.innerHTML = `
                    <div class="fail">
                        âŒ é”™è¯¯ï¼šæ‚¨æ­£åœ¨ä½¿ç”¨ file:// åè®®æ‰“å¼€æ–‡ä»¶ï¼<br>
                        è¿™æ ·æ— æ³•è®¿é—®éº¦å…‹é£ã€‚<br>
                        è¯·ä½¿ç”¨HTTPæœåŠ¡å™¨è®¿é—®ã€‚
                    </div>
                `;
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                check.innerHTML = `
                    <div class="pass">
                        âœ… æ­£ç¡®ï¼šæ‚¨æ­£åœ¨é€šè¿‡ localhost è®¿é—®<br>
                        éº¦å…‹é£åŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚
                    </div>
                `;
            } else if (protocol === 'https:') {
                check.innerHTML = `
                    <div class="pass">
                        âœ… æ­£ç¡®ï¼šæ‚¨æ­£åœ¨é€šè¿‡ HTTPS è®¿é—®<br>
                        éº¦å…‹é£åŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚
                    </div>
                `;
            } else {
                check.innerHTML = `
                    <div class="fail">
                        âŒ è­¦å‘Šï¼šéå®‰å…¨çš„HTTPè®¿é—®<br>
                        æŸäº›æµè§ˆå™¨å¯èƒ½é™åˆ¶éº¦å…‹é£è®¿é—®ã€‚
                    </div>
                `;
            }
        }

        // 3. æµ‹è¯•éº¦å…‹é£
        async function testMicrophone() {
            const button = document.getElementById('test-mic');
            const status = document.getElementById('mic-status');

            button.disabled = true;
            status.innerHTML = 'æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                status.innerHTML = '<div class="pass">âœ… éº¦å…‹é£æƒé™è·å–æˆåŠŸï¼</div>';

                // æµ‹è¯•éŸ³é¢‘ä¸Šä¸‹æ–‡
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);

                status.innerHTML += '<div class="pass">âœ… éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸï¼</div>';

                // åœæ­¢æµ
                stream.getTracks().forEach(track => track.stop());

            } catch (error) {
                console.error('éº¦å…‹é£æµ‹è¯•å¤±è´¥:', error);
                status.innerHTML = `<div class="fail">âŒ é”™è¯¯ï¼š${error.message}</div>`;

                if (error.name === 'NotAllowedError') {
                    status.innerHTML += '<p>è¯·å…è®¸æµè§ˆå™¨è®¿é—®éº¦å…‹é£ã€‚</p>';
                } else if (error.name === 'NotFoundError') {
                    status.innerHTML += '<p>æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡ã€‚</p>';
                }
            }

            button.disabled = false;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            checkBrowserSupport();
            checkProtocol();

            document.getElementById('test-mic').addEventListener('click', testMicrophone);
        });
    </script>
</body>
</html>