<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•é¡µé¢ - æ—©è¯»ç¥å™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>ğŸ” æ—©è¯»ç¥å™¨è°ƒè¯•é¡µé¢</h1>

    <div class="debug-section">
        <h2>1. æ¨¡å—åŠ è½½æµ‹è¯•</h2>
        <button onclick="testModuleLoading()">æµ‹è¯•æ¨¡å—åŠ è½½</button>
        <div id="module-result"></div>
    </div>

    <div class="debug-section">
        <h2>2. éº¦å…‹é£æƒé™æµ‹è¯•</h2>
        <button onclick="testMicrophone()">æµ‹è¯•éº¦å…‹é£</button>
        <div id="mic-result"></div>
    </div>

    <div class="debug-section">
        <h2>3. å¯åŠ¨å®Œæ•´åº”ç”¨</h2>
        <button onclick="startApp()">å¯åŠ¨æ—©è¯»ç¥å™¨</button>
        <div id="app-result"></div>
    </div>

    <div class="debug-section">
        <h2>4. æ§åˆ¶å°æ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="log"></div>
    </div>

    <script type="module">
        // é‡å†™consoleæ–¹æ³•æ¥æ•è·æ—¥å¿—
        const log = document.getElementById('log');
        const originalLog = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        function addToLog(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');

            log.innerHTML += `<span class="${type}">[${timestamp}] ${type.toUpperCase()}: ${message}</span>\n`;
            log.scrollTop = log.scrollHeight;

            // åŒæ—¶è¾“å‡ºåˆ°åŸå§‹æ§åˆ¶å°
            originalLog[type](...args);
        }

        console.log = (...args) => addToLog('info', ...args);
        console.error = (...args) => addToLog('error', ...args);
        console.warn = (...args) => addToLog('warn', ...args);
        console.info = (...args) => addToLog('info', ...args);

        // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.testModuleLoading = async function() {
            const resultDiv = document.getElementById('module-result');
            resultDiv.innerHTML = '<p style="color: blue;">æ­£åœ¨æµ‹è¯•æ¨¡å—åŠ è½½...</p>';

            try {
                // æµ‹è¯•å¯¼å…¥å„ä¸ªæ¨¡å—
                const AudioDetector = await import('./scripts/audio.js');
                resultDiv.innerHTML += '<p class="success">âœ“ audio.js åŠ è½½æˆåŠŸ</p>';

                const AnimalManager = await import('./scripts/animals.js');
                resultDiv.innerHTML += '<p class="success">âœ“ animals.js åŠ è½½æˆåŠŸ</p>';

                const SettingsManager = await import('./scripts/settings.js');
                resultDiv.innerHTML += '<p class="success">âœ“ settings.js åŠ è½½æˆåŠŸ</p>';

                resultDiv.innerHTML += '<p class="success"><strong>æ‰€æœ‰æ¨¡å—åŠ è½½æˆåŠŸï¼</strong></p>';
            } catch (error) {
                resultDiv.innerHTML += `<p class="error">âœ— æ¨¡å—åŠ è½½å¤±è´¥: ${error.message}</p>`;
                console.error('æ¨¡å—åŠ è½½é”™è¯¯:', error);
            }
        };

        window.testMicrophone = async function() {
            const resultDiv = document.getElementById('mic-result');
            resultDiv.innerHTML = '<p style="color: blue;">æ­£åœ¨æµ‹è¯•éº¦å…‹é£...</p>';

            try {
                // è¯·æ±‚éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                resultDiv.innerHTML += '<p class="success">âœ“ éº¦å…‹é£æƒé™è·å–æˆåŠŸ</p>';

                // æ£€æŸ¥éŸ³é¢‘è½¨é“
                const audioTracks = stream.getAudioTracks();
                if (audioTracks.length > 0) {
                    resultDiv.innerHTML += `<p class="success">âœ“ æ‰¾åˆ° ${audioTracks.length} ä¸ªéŸ³é¢‘è½¨é“</p>`;

                    // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡æ¥æµ‹è¯•éŸ³é‡
                    const audioContext = new AudioContext();
                    const source = audioContext.createMediaStreamSource(stream);
                    const analyser = audioContext.createAnalyser();
                    source.connect(analyser);

                    resultDiv.innerHTML += '<p class="success">âœ“ éŸ³é¢‘åˆ†æå™¨åˆ›å»ºæˆåŠŸ</p>';

                    // ç›‘å¬éŸ³é‡å˜åŒ–
                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    const checkVolume = () => {
                        analyser.getByteFrequencyData(dataArray);
                        const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                        if (average > 0) {
                            resultDiv.innerHTML += `<p class="success">âœ“ æ£€æµ‹åˆ°å£°éŸ³ï¼éŸ³é‡: ${average.toFixed(2)}</p>`;
                            stream.getTracks().forEach(track => track.stop());
                            return;
                        }
                        setTimeout(checkVolume, 100);
                    };
                    checkVolume();
                } else {
                    resultDiv.innerHTML += '<p class="error">âœ— æœªæ‰¾åˆ°éŸ³é¢‘è½¨é“</p>';
                }
            } catch (error) {
                resultDiv.innerHTML += `<p class="error">âœ— éº¦å…‹é£æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
                console.error('éº¦å…‹é£é”™è¯¯:', error);

                if (error.name === 'NotAllowedError') {
                    resultDiv.innerHTML += '<p class="error">è¯·å…è®¸æµè§ˆå™¨è®¿é—®éº¦å…‹é£</p>';
                } else if (error.name === 'NotFoundError') {
                    resultDiv.innerHTML += '<p class="error">æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡</p>';
                }
            }
        };

        window.startApp = async function() {
            const resultDiv = document.getElementById('app-result');
            resultDiv.innerHTML = '<p style="color: blue;">æ­£åœ¨å¯åŠ¨åº”ç”¨...</p>';

            try {
                // å¯¼å…¥å¹¶åˆ›å»ºåº”ç”¨å®ä¾‹
                const { default: MorningReadingZoo } = await import('./scripts/main.js');

                // æ£€æŸ¥åº”ç”¨æ˜¯å¦å·²è‡ªåŠ¨åˆå§‹åŒ–
                if (window.zooApp) {
                    resultDiv.innerHTML += '<p class="success">âœ“ åº”ç”¨å·²è‡ªåŠ¨åˆå§‹åŒ–</p>';

                    // å°è¯•ç‚¹å‡»å¼€å§‹æŒ‰é’®
                    const welcomeStartBtn = document.getElementById('welcome-start-btn');
                    if (welcomeStartBtn) {
                        resultDiv.innerHTML += '<p style="color: blue;">æ¨¡æ‹Ÿç‚¹å‡»å¼€å§‹æŒ‰é’®...</p>';
                        welcomeStartBtn.click();
                        resultDiv.innerHTML += '<p class="success">âœ“ å¼€å§‹æŒ‰é’®å·²ç‚¹å‡»</p>';
                    } else {
                        resultDiv.innerHTML += '<p class="error">âœ— æœªæ‰¾åˆ°å¼€å§‹æŒ‰é’®</p>';
                    }
                } else {
                    resultDiv.innerHTML += '<p class="error">âœ— åº”ç”¨æœªè‡ªåŠ¨åˆå§‹åŒ–</p>';
                }
            } catch (error) {
                resultDiv.innerHTML += `<p class="error">âœ— å¯åŠ¨å¤±è´¥: ${error.message}</p>`;
                console.error('å¯åŠ¨é”™è¯¯:', error);
            }
        };

        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };

        // åˆå§‹æ—¥å¿—
        console.info('è°ƒè¯•é¡µé¢å·²åŠ è½½');
        console.info('å½“å‰URL:', window.location.href);
        console.info('æµè§ˆå™¨ä¿¡æ¯:', navigator.userAgent);
    </script>
</body>
</html>